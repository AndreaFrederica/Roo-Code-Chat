# 测试思考块重复渲染修复

这是一个测试文档，用于验证混合折叠管线的修复效果。

## 测试用例1：UpdateVariable标签

<UpdateVariable>
_.set('白秋眠.心理状态.内心想法[0]', '逃跑...是不可能的。反抗...只会死得更快。那么...我唯一能做的，就是活下去。不管用什么方法，都要活下去...为了那些村民，也为了...神父爷爷...');//内心想法更新
_.set('白秋眠.心理状态.情绪状态.主要情绪[0]', '思考、恐惧与一丝冷静');//主要情绪更新
_.set('白秋眠.外观状态.表情[0]', '眼神不再只有恐惧，多了一丝深思和决然，眉头微蹙，像是在盘算着什么');//表情更新
_.set('白秋眠.外观状态.姿势[0]', '身体完全靠在池壁上，双臂搭在池边，头部微微后仰，任由湿发垂入水中');//姿势更新
</UpdateVariable>

## 测试用例2：思考标签

<thinking>
白秋眠没有立刻起身。她将整个身体都靠在光滑的池壁上，感受着温热的水流包裹着每一寸肌肤，驱散着连日奔波带来的疲惫和寒意。脚底的伤口在热水的浸泡下，疼痛感已经减轻了许多，变成了一种可以忍受的酥麻。

这片刻的安宁，是她这几天来从未有过的奢侈。

她闭上眼睛，长长的睫毛上挂着水珠，微微颤动着。她强迫自己不再去想那些可怕的画面，而是开始冷静地思考。

逃跑？这个念头只是一闪而过就被她否决了。这里是鸦巢堡，是土匪的老巢，她一个手无寸铁的女孩，怎么可能逃得出去？就算侥幸逃出了这个房间，外面还有数不清的土匪，她只会被抓回来，然后遭受更可怕的对待。

反抗？她想起了雾雨魔理沙那双冰冷而充满压迫感的眼睛，想起了他呵斥手下时那不容置喙的气场。反抗他，无异于以卵击石，只会招来更残酷的对待，甚至死亡。

那么，她剩下的路，只有一条。

活下去。

用尽一切办法，活下去。
</thinking>

## 测试用例3：混合标签

普通文本内容

<UpdateVariable>
_.set('测试.变量[0]', '这是UpdateVariable标签的内容');
</UpdateVariable>

更多普通文本

<thinking>
这是思考标签的内容，应该被正确折叠。
包含一些 **markdown** 格式。
</thinking>

## 测试用例4：嵌套标签

<thinking>
外层思考内容
<UpdateVariable>
_.set('嵌套.测试[0]', '嵌套在思考块中的变量');
</UpdateVariable>
继续思考内容
</thinking>

## 预期结果

1. UpdateVariable标签应该只渲染一次，不重复
2. 思考标签应该正确折叠，默认状态为折叠
3. 混合标签应该各自独立处理，不互相干扰
4. 嵌套标签应该正确处理，不出现重复渲染
5. 折叠状态在流式更新时应该保持稳定

## 修复要点

1. **避免双重处理**：正则系统和AST系统不应该处理相同类型的标签
2. **内容去重**：同一个内容不应该被添加到最终块列表多次
3. **折叠状态稳定**：折叠状态不应该在每次渲染时重置
4. **类型冲突检测**：检测并跳过重复的规则类型
