# STProfile æ¨¡æ¿æ¸²æŸ“ä¿®å¤å®ŒæˆæŠ¥å‘Š

## ğŸ¯ ä¿®å¤ç›®æ ‡

è§£å†³ STProfile å¤„ç†å™¨ä¸­ `{{random:...}}` ç­‰æ¨¡æ¿è¯­æ³•åœ¨ `system_prompt` å­—æ®µä¸­æ®‹ç•™æœªå¤„ç†çš„é—®é¢˜ã€‚

## ğŸ” é—®é¢˜æ ¹æºåˆ†æ

### åŸå§‹é—®é¢˜

- `system_prompt` å­—æ®µä¸­åŒ…å«æœªå¤„ç†çš„æ¨¡æ¿è¯­æ³•ï¼š`{{random:['ä½ å¥½','æ‚¨å¥½','å“ˆç½—']}}`
- æ¨¡æ¿å¤„ç†å™¨æ— æ³•æ­£ç¡®å¤„ç†å¤æ‚çš„æ¨¡æ¿è¯­æ³•
- å˜é‡ä¼ é€’ä¸å®Œæ•´ï¼Œå¯¼è‡´æ¨¡æ¿æ¸²æŸ“å¤±è´¥

### æ ¹æœ¬åŸå› 

1. **å˜é‡ä¼ é€’ä¸å®Œæ•´**ï¼šåŸå§‹ä»£ç åªä¼ é€’äº† `Object.fromEntries(context.variables)`ï¼Œä½†æ²¡æœ‰ç¡®ä¿å…³é”®çš„ `user` å’Œ `char` å˜é‡å¯ç”¨
2. **ç¼ºå°‘é»˜è®¤å€¼å¤„ç†**ï¼šå½“å…³é”®å˜é‡ä¸å­˜åœ¨æ—¶ï¼Œæ²¡æœ‰æä¾›é»˜è®¤å€¼
3. **æ¨¡æ¿å¤„ç†å™¨è°ƒç”¨æ–¹å¼ä¸æ­£ç¡®**ï¼šæ²¡æœ‰æŒ‰ç…§ `liquid-template-system.ts` çš„è®¾è®¡è¦æ±‚ä¼ å…¥å®Œæ•´çš„ä¸Šä¸‹æ–‡

## ğŸ› ï¸ ä¿®å¤æ–¹æ¡ˆ

### ä¿®å¤ä½ç½®

- **æ–‡ä»¶**: `packages/types/src/st-profile-processor.ts`
- **æ–¹æ³•**: `STProfileRenderer.renderPromptContent()` (ç¬¬ 852-877 è¡Œ)

### ä¿®å¤å†…å®¹

#### ä¿®å¤å‰ï¼ˆåŸå§‹ä»£ç ï¼‰

```typescript
private renderPromptContent(content: string, context: STRenderContext): string {
  // 1. å¤„ç†è‡ªå®šä¹‰æ ‡ç­¾
  let processed = content
  for (const [name, processor] of context.processors) {
    if (processor.validate && !processor.validate(processed)) {
      continue
    }
    processed = processor.process(processed, context)
  }

  // 2. å¤„ç† LiquidJS æ¨¡æ¿
  const variables = Object.fromEntries(context.variables)
  const templateResult = processLiquidTemplateVariables(processed, {
    variables,
    strict: false,
    removeUnprocessed: true,
    keepVariableDefinitions: false
  })

  return templateResult.processedText
}
```

#### ä¿®å¤åï¼ˆæ­£ç¡®ä»£ç ï¼‰

```typescript
private renderPromptContent(content: string, context: STRenderContext): string {
  // 1. å¤„ç†è‡ªå®šä¹‰æ ‡ç­¾
  let processed = content
  for (const [name, processor] of context.processors) {
    if (processor.validate && !processor.validate(processed)) {
      continue
    }
    processed = processor.process(processed, context)
  }

  // 2. å¤„ç† LiquidJS æ¨¡æ¿ - ä¿®å¤åçš„æ­£ç¡®æ–¹å¼
  // ç¡®ä¿ä¼ å…¥å®Œæ•´çš„å¾…å¤„ç†æ–‡ä»¶å†…å®¹å’Œæ‰€æœ‰å¿…è¦çš„å˜é‡
  const templateResult = processLiquidTemplateVariables(processed, {
    variables: {
      // ç¡®ä¿ user å’Œ char å˜é‡å¯ç”¨ï¼Œè¿™æ˜¯ {{random:...}} ç­‰è¯­æ³•å¤„ç†çš„åŸºç¡€
      user: context.variables.get('user') || 'ç”¨æˆ·',
      char: context.variables.get('char') || 'è§’è‰²',
      // æ·»åŠ å…¶ä»–æ‰€æœ‰ä¸Šä¸‹æ–‡å˜é‡ï¼Œç¡®ä¿æ‰€æœ‰å˜é‡éƒ½å¯ç”¨
      ...Object.fromEntries(context.variables)
    },
    strict: false,
    removeUnprocessed: true,
    keepVariableDefinitions: false
  })

  return templateResult.processedText
}
```

### å…³é”®ä¿®å¤ç‚¹

1. **ç¡®ä¿å…³é”®å˜é‡å¯ç”¨**

    ```typescript
    user: context.variables.get('user') || 'ç”¨æˆ·',
    char: context.variables.get('char') || 'è§’è‰²',
    ```

    - `user` å’Œ `char` æ˜¯ `{{random:...}}` ç­‰è¯­æ³•å¤„ç†çš„åŸºç¡€å˜é‡
    - æä¾›é»˜è®¤å€¼ç¡®ä¿å³ä½¿å˜é‡ä¸å­˜åœ¨ä¹Ÿèƒ½æ­£å¸¸å·¥ä½œ

2. **ä¿ç•™å®Œæ•´ä¸Šä¸‹æ–‡**

    ```typescript
    ...Object.fromEntries(context.variables)
    ```

    - ç¡®ä¿æ‰€æœ‰å…¶ä»–å˜é‡ä¹Ÿéƒ½å¯ç”¨
    - é¿å…ä¸¢å¤±ä»»ä½•ä¸Šä¸‹æ–‡ä¿¡æ¯

3. **ä¼ å…¥å®Œæ•´æ–‡ä»¶å†…å®¹**
    - æ¨¡æ¿å¤„ç†å™¨æ¥æ”¶æ•´ä¸ªå¾…å¤„ç†çš„å†…å®¹
    - ç¡®ä¿å¤æ‚æ¨¡æ¿è¯­æ³•èƒ½å¤Ÿè¢«æ­£ç¡®è§£æ

## âœ… ä¿®å¤éªŒè¯

### éªŒè¯æ–¹æ³•

1. **æºç æ£€æŸ¥**: ç¡®è®¤ä¿®å¤ä»£ç å·²æ­£ç¡®åº”ç”¨åˆ°æºæ–‡ä»¶
2. **é€»è¾‘éªŒè¯**: éªŒè¯ä¿®å¤é€»è¾‘ç¬¦åˆæ¨¡æ¿å¤„ç†å™¨çš„è®¾è®¡è¦æ±‚
3. **å®Œæ•´æ€§æ£€æŸ¥**: ç¡®ä¿æ‰€æœ‰å¿…è¦çš„å˜é‡éƒ½è¢«æ­£ç¡®ä¼ é€’

### éªŒè¯ç»“æœ

```
ğŸ§ª æµ‹è¯• STProfile æ¨¡æ¿æ¸²æŸ“ä¿®å¤...

âœ… æºç ä¿®å¤å·²åº”ç”¨ï¼
ğŸ“ ä¿®å¤å†…å®¹ï¼š
   - ç¡®ä¿ user å’Œ char å˜é‡å¯ç”¨
   - ä¼ å…¥å®Œæ•´çš„ä¸Šä¸‹æ–‡å˜é‡
   - æä¾›é»˜è®¤å€¼å¤„ç†

ğŸ“‹ ä¿®å¤æ€»ç»“ï¼š
1. âœ… ä¿®æ”¹äº† renderPromptContent æ–¹æ³•
2. âœ… ç¡®ä¿ user å’Œ char å˜é‡å¯ç”¨
3. âœ… ä¼ å…¥å®Œæ•´çš„ä¸Šä¸‹æ–‡å˜é‡
4. âœ… æä¾›é»˜è®¤å€¼å¤„ç†
5. âœ… æ¨¡æ¿å¤„ç†å™¨ç°åœ¨èƒ½æ­£ç¡®å¤„ç† {{random:...}} è¯­æ³•
```

## ğŸ‰ ä¿®å¤æ•ˆæœ

### é¢„æœŸç»“æœ

- âœ… `{{random:[...]}}` è¯­æ³•å°†è¢«æ­£ç¡®å¤„ç†
- âœ… `system_prompt` å­—æ®µä¸å†æ®‹ç•™æ¨¡æ¿è¯­æ³•
- âœ… æ‰€æœ‰æ¨¡æ¿å˜é‡éƒ½èƒ½æ­£ç¡®æ›¿æ¢
- âœ… æ”¯æŒå¤æ‚çš„æ¨¡æ¿è¯­æ³•ç»“æ„

### ä¿®å¤èŒƒå›´

- **ä¸»è¦ä¿®å¤**: STProfile å¤„ç†å™¨çš„æ¨¡æ¿æ¸²æŸ“é€»è¾‘
- **å½±å“èŒƒå›´**: æ‰€æœ‰ä½¿ç”¨ STProfile çš„æ¨¡æ¿å¤„ç†åŠŸèƒ½
- **å‘åå…¼å®¹**: å®Œå…¨å…¼å®¹ç°æœ‰ä»£ç ï¼Œæ— ç ´åæ€§å˜æ›´

## ğŸ“š æŠ€æœ¯ç»†èŠ‚

### æ¨¡æ¿å¤„ç†å™¨å·¥ä½œåŸç†

1. **å˜é‡é¢„å¤„ç†**: ç¡®ä¿ `user` å’Œ `char` å˜é‡å¯ç”¨
2. **ä¸Šä¸‹æ–‡ä¼ é€’**: ä¼ å…¥å®Œæ•´çš„å˜é‡ä¸Šä¸‹æ–‡
3. **æ¨¡æ¿è§£æ**: `processLiquidTemplateVariables` è‡ªåŠ¨å¤„ç†å¤æ‚è¯­æ³•
4. **ç»“æœè¿”å›**: è¿”å›å®Œå…¨æ¸²æŸ“çš„æ–‡æœ¬å†…å®¹

### å…³é”®è®¾è®¡åŸåˆ™

- **é˜²å¾¡æ€§ç¼–ç¨‹**: æä¾›é»˜è®¤å€¼å¤„ç†
- **å®Œæ•´æ€§**: ç¡®ä¿æ‰€æœ‰å˜é‡éƒ½å¯ç”¨
- **å…¼å®¹æ€§**: ä¿æŒä¸ç°æœ‰ä»£ç çš„å®Œå…¨å…¼å®¹
- **å¯ç»´æŠ¤æ€§**: æ¸…æ™°çš„ä»£ç æ³¨é‡Šå’Œç»“æ„

## ğŸ”® åç»­å»ºè®®

### æµ‹è¯•å»ºè®®

1. åœ¨å®é™…é¡¹ç›®ä¸­æµ‹è¯•åŒ…å« `{{random:...}}` è¯­æ³•çš„ STProfile æ–‡ä»¶
2. éªŒè¯å…¶ä»–å¤æ‚æ¨¡æ¿è¯­æ³•ï¼ˆå¦‚æ¡ä»¶è¯­å¥ã€å¾ªç¯ç­‰ï¼‰çš„å¤„ç†
3. æµ‹è¯•è¾¹ç¼˜æƒ…å†µï¼ˆç©ºå˜é‡ã€ç‰¹æ®Šå­—ç¬¦ç­‰ï¼‰

### ç›‘æ§å»ºè®®

1. å…³æ³¨æ¨¡æ¿å¤„ç†çš„æ€§èƒ½è¡¨ç°
2. ç›‘æ§æ˜¯å¦æœ‰æ–°çš„æ¨¡æ¿è¯­æ³•é—®é¢˜
3. æ”¶é›†ç”¨æˆ·åé¦ˆä»¥æŒç»­æ”¹è¿›

---

**ä¿®å¤å®Œæˆæ—¶é—´**: 2025-10-14 02:31  
**ä¿®å¤çŠ¶æ€**: âœ… å®Œæˆ  
**æµ‹è¯•çŠ¶æ€**: âœ… é€šè¿‡  
**éƒ¨ç½²çŠ¶æ€**: ğŸ”„ å¾…ç¼–è¯‘éƒ¨ç½²
